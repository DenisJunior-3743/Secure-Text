name: 🔁 Auto Build & Release SecureText

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest tag
        id: get_tag
        run: |
          TAG=$(git tag --sort=-v:refname | head -n 1)
          if [ -z "$TAG" ]; then
            echo "latest_tag=" >> $GITHUB_OUTPUT
          else
            echo "latest_tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: Bump version automatically
        id: bump
        run: |
          latest_tag="${{ steps.get_tag.outputs.latest_tag }}"
          if [ -z "$latest_tag" ]; then
            new_tag=v1
          else
            num=$(echo "$latest_tag" | grep -oE '[0-9]+$')
            new_tag="v$((num+1))"
          fi
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Next version: $new_tag"

  build:
    needs: version
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: ${{ matrix.arch }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build SecureText Executable
        run: |
          pyinstaller --onefile --noconsole main.py --icon=app.ico
          mkdir dist_upload
          copy dist\\main.exe dist_upload\\SecureText-${{ matrix.arch }}.exe

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SecureText-${{ matrix.arch }}
          path: dist_upload/SecureText-${{ matrix.arch }}.exe

  release:
    needs: [build, version]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: "SecureText ${{ needs.version.outputs.tag }}"
          body: |
            🚀 Auto-built SecureText release  
            Includes executables for 64-bit and 32-bit Windows.  

            🔽 Downloads:
            - SecureText-x64.exe
            - SecureText-x86.exe
          files: |
            artifacts/**/SecureText-x64.exe
            artifacts/**/SecureText-x86.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
